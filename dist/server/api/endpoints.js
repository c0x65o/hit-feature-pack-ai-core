import { NextResponse } from 'next/server';
import fs from 'node:fs';
import path from 'node:path';
import { extractUserFromRequest } from '../auth';
import { discoverAppApiEndpoints } from '../lib/ai-endpoints';
export const dynamic = 'force-dynamic';
export const runtime = 'nodejs';
export async function GET(request) {
    const user = extractUserFromRequest(request);
    if (!user) {
        return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }
    // Prefer static catalog generated by `hit run`.
    const projectRoot = process.cwd();
    const capsPath = path.join(projectRoot, '.hit', 'generated', 'capabilities.json');
    if (fs.existsSync(capsPath)) {
        try {
            const raw = fs.readFileSync(capsPath, 'utf8');
            const caps = JSON.parse(raw);
            return NextResponse.json(caps);
        }
        catch {
            // fall back
        }
    }
    // Fallback: runtime discovery (dev convenience)
    const endpoints = discoverAppApiEndpoints(path.join(projectRoot));
    return NextResponse.json({ generated: false, kind: 'hit-capabilities', endpoints });
}
